<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><link href="css/default.css" rel="stylesheet" type="text/css" /><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>mongologic.core documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Mongologic</span> <span class="project-version">0.5.6</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>mongologic</span></div></div></li><li class="depth-2 branch current"><a href="mongologic.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><a href="mongologic.history.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>history</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="mongologic.core.html#var-add-to-callback-queue"><div class="inner"><span>add-to-callback-queue</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-beginning-of-day"><div class="inner"><span>beginning-of-day</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-count"><div class="inner"><span>count</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-create"><div class="inner"><span>create</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-delete"><div class="inner"><span>delete</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-delete-all"><div class="inner"><span>delete-all</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-find"><div class="inner"><span>find</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-find-by-id"><div class="inner"><span>find-by-id</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-find-contiguous"><div class="inner"><span>find-contiguous</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-find-next"><div class="inner"><span>find-next</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-find-one"><div class="inner"><span>find-one</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-find-prev"><div class="inner"><span>find-prev</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-page"><div class="inner"><span>page</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-to-object-id"><div class="inner"><span>to-object-id</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-unique.3F"><div class="inner"><span>unique?</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-update"><div class="inner"><span>update</span></div></a></li><li class="depth-1"><a href="mongologic.core.html#var-update-all"><div class="inner"><span>update-all</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">mongologic.core</h1><div class="doc"><pre class="plaintext"></pre></div><div class="public anchor" id="var-add-to-callback-queue"><h3>add-to-callback-queue</h3><div class="usage"><code>(add-to-callback-queue callback-queue callback-fn)</code></div><div class="doc"><pre class="plaintext">#IMPORTANT
Callback queues currently only supported in :after-update and :after-delete

Example:

     (swap! (get-in component [:entity :after-update])  ; must be an atom
            add-to-callback-queue
            new-callback-fn)</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L669">view source</a></div></div><div class="public anchor" id="var-beginning-of-day"><h3>beginning-of-day</h3><div class="usage"><code>(beginning-of-day date-field utc-offset-in-milliseconds)</code></div><div class="doc"><pre class="plaintext">Returns a map, to be used in the context of CongoMongo's interface to
MongoDB's aggregation framework [^1][^2], to get a Date value with the same
day as the one resulting from adding utc-offset-in-milliseconds to the
specified date-field (expected as a keyword, like in :field-name), but with
a time of 0:00 .

Ex.

    (beginning-of-day :created_at 7200000)
    =&gt;
    {:$subtract
       [{:$add ["$created_at" 7200000]}
        {:$add [{:$millisecond [{:$add ["$created_at" 7200000]}]}
                {:$multiply [{:$second [{:$add ["$created_at" 7200000]}]}
                             1000]}
                {:$multiply [{:$minute [{:$add ["$created_at" 7200000]}]}
                             60
                             1000]}
                {:$multiply [{:$hour [{:$add ["$created_at" 7200000]}]}
                             60
                             60
                             1000]}]}]}

[^1]: <a href="https://github.com/aboekhoff/congomongo#aggregation-requires-mongodb-22-or-later">https://github.com/aboekhoff/congomongo#aggregation-requires-mongodb-22-or-later</a>
[^2]: <a href="http://docs.mongodb.org/manual/core/aggregation-pipeline/">http://docs.mongodb.org/manual/core/aggregation-pipeline/</a></pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L685">view source</a></div></div><div class="public anchor" id="var-count"><h3>count</h3><div class="usage"><code>(count {:keys [database entity], :as model-component} &amp; [{:keys [where]}])</code></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L131">view source</a></div></div><div class="public anchor" id="var-create"><h3>create</h3><div class="usage"><code>(create {:keys [database entity], :as model-component} attributes)</code></div><div class="doc"><pre class="plaintext">These callbacks will be called, in the order listed here, if defined in
the map under the :entity key of the `model-component` parameter:

- :before-validation
- :before-validation-on-create
- :validator
- :before-save
- :before-create
- :after-create

All callbacks will be passed the model-component and the attributes map.
The :validator callback must return a collection of errors (empty or nil if
no errors). The other callbacks must return the possibly updated attributes
map.

Returns:
  - [false validation-errors] if validations fail (where validation-errors
  is what the validator returned)
  - [false {:base [:insert-error]}] if insertion into the database fails
  - [true created-object] otherwise (created-object will have an :_id and
    :created_at and :updated_at timestamps)</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L12">view source</a></div></div><div class="public anchor" id="var-delete"><h3>delete</h3><div class="usage"><code>(delete {:keys [database entity], :as model-component} id)</code></div><div class="doc"><pre class="plaintext">If the id parameter is a String, it's automatically converted to an
ObjectId.

These callbacks will be called, in the order listed here, if defined in the
map under the :entity key of the `model-component` parameter:

- :before-delete
- :after-delete

Returns:
  - the number of records deleted</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L408">view source</a></div></div><div class="public anchor" id="var-delete-all"><h3>delete-all</h3><div class="usage"><code>(delete-all {:keys [database entity], :as model-component} query)</code></div><div class="doc"><pre class="plaintext">Returns:
- the number of records deleted</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L471">view source</a></div></div><div class="public anchor" id="var-find"><h3>find</h3><div class="usage"><code>(find {:keys [database entity], :as model-component} &amp; [{:keys [where sort limit explain?]}])</code></div><div class="doc"><pre class="plaintext">Returns a lazy sequence of records, optionally limited to :limit, matching
the conditions specified in :where and ordered by :sort (all keys are
optional).

If the second parameter contains an :explain? key with a truthy value, then
a map with information about the query plan is returned instead.</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L97">view source</a></div></div><div class="public anchor" id="var-find-by-id"><h3>find-by-id</h3><div class="usage"><code>(find-by-id model-component id)</code></div><div class="doc"><pre class="plaintext"></pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L126">view source</a></div></div><div class="public anchor" id="var-find-contiguous"><h3>find-contiguous</h3><div class="usage"><code>(find-contiguous model-component document attribute-name conditions &amp; [order])</code></div><div class="doc"><pre class="plaintext">Returns the document/record that follows (if `order` is 1, the default) or
precedes (if `order` is -1) the specified `document` when the documents
matching `conditions` are ordered by `attribute-name`.

Ex.
(find-contiguous post-component current-post :posted_at {:author_id &lt;id&gt;} 1)</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L136">view source</a></div></div><div class="public anchor" id="var-find-next"><h3>find-next</h3><div class="usage"><code>(find-next model-component document attribute-name &amp; [conditions])</code></div><div class="doc"><pre class="plaintext">Returns the document (record) that follows the specified `document` when
the documents matching `conditions` are ordered by `attribute-name`.

(Convenience function for `find-contiguous` when the order param is 1.)</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L156">view source</a></div></div><div class="public anchor" id="var-find-one"><h3>find-one</h3><div class="usage"><code>(find-one {:keys [database entity], :as model-component} where)</code></div><div class="doc"><pre class="plaintext">Returns a map with the first [^1] record matching the conditions specified
in the `where` parameter, or nil if no record is found.

(Cannot be used with :sort, use find with :limit 1 instead.)

[^1]: According to the "natural order"
<a href="http://docs.mongodb.org/manual/reference/method/db.collection.findOne/">http://docs.mongodb.org/manual/reference/method/db.collection.findOne/</a></pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L114">view source</a></div></div><div class="public anchor" id="var-find-prev"><h3>find-prev</h3><div class="usage"><code>(find-prev model-component document attribute-name &amp; [conditions])</code></div><div class="doc"><pre class="plaintext">Returns the document (record) that precedes the specified `document` when
the documents matching `conditions` are ordered by `attribute-name`.

(Convenience function for `find-contiguous` when the order param is -1.)</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L164">view source</a></div></div><div class="public anchor" id="var-page"><h3>page</h3><div class="usage"><code>(page {:keys [database entity], :as model-component} {where :where, sort-order :sort} start page-size)</code></div><div class="doc"><pre class="plaintext">Returns a page of the records specified by :where and ordered by :sort.
It implements "range-based pagination" [^1]. The desired page is
specified in the `start` parameter as a map with the values of the sort
fields [^2] that the first record in the page must match.

[^1] As recommended in MongoDB manual when discussing cursor.skip()
<a href="http://docs.mongodb.org/manual/reference/method/cursor.skip/">http://docs.mongodb.org/manual/reference/method/cursor.skip/</a>
[^2]: Plus the :_id field if necessary to disambiguate

Ex.
    (page post-component
          ;; The default sort order is `:sort {:_id 1}`. If the :sort map
          ;; has more than 1 element, it should be an array-map, which
          ;; maintains key order.
          ;; When the whole map is nil, it pages through all records with
          ;; the default sort order.
          {:where {:author_id &lt;author_id&gt;} :sort {:posted_at -1}}
          ;; start, when it's nil the 1st page is returned
          {:posted_at
             (clj-time.coerce/from-string "2015-08-25T14:37:30.947Z")
           :_id
             (mongologic/to-object-id "51b5da900364618037ff21e7")}
          ;; page-size
          100)

Returns:
    {:items (...)
     :previous-page-start {...}
     :next-page-start {...}}</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L522">view source</a></div></div><div class="public anchor" id="var-to-object-id"><h3>to-object-id</h3><div class="usage"><code>(to-object-id id)</code></div><div class="doc"><pre class="plaintext">Returns the MongoDB ObjectId corresponding to id, which may be the
hexadecimal string value of the ObjectId, or the ObjectId itself.
It may raise an exception if the id is not a valid ObjectId (ex. if it's
the empty string, or nil).</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L743">view source</a></div></div><div class="public anchor" id="var-unique.3F"><h3>unique?</h3><div class="usage"><code>(unique? model-component attributes unique-key-fields &amp; [scope-conditions])</code></div><div class="doc"><pre class="plaintext">Checks that there are no other records in the collection corresponding to
model-component with the same values for the combination of fields
specified in unique-key-fields. The uniqueness constraint can be scoped to
records matching scope-conditions (the default scope is the whole
collection). Ex.

    (unique? book-component
             book-record
             [:title :author_id]
             {:status "active"})

If the record's attributes contain an :_id, it's assumed that these
attributes correspond to an existing record and the uniqueness check will
not take into account any record with that same :_id (so it will not take
itself into account).</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L626">view source</a></div></div><div class="public anchor" id="var-update"><h3>update</h3><div class="usage"><code>(update {:keys [database entity], :as model-component} id attributes &amp; [{:keys [skip-validations], :or {skip-validations false}}])</code></div><div class="doc"><pre class="plaintext">If validation succeeds for the record specified by `id` with the changed
`attributes`, the resulting record is saved (with an automatically
:updated_at timestamp, unless it's explicitly changed). If `attributes` are
not really changing anything, nothing is saved.

Only the $unset "update operator" is supported.
<a href="http://docs.mongodb.org/manual/reference/operators/#update">http://docs.mongodb.org/manual/reference/operators/#update</a>

$unset allows to delete fields. To delete a field, specify :$unset as its
new value. Example:

  (update user-component
          23
          {:password "s3cret" :password_reset_code :$unset})

Notice that it's possible to delete fields in the same update as others are
set.

These callbacks will be called, in the order listed here, if defined in
the map under the :entity key of the `model-component` parameter:
- :before-validation
- :validator
- :before-save
- :before-update
- :on-update-errors
- :after-update

All callbacks will be passed the `model-component` and the entire record
with the corresponding attributes updated. The :validator callback must
return a collection of errors (empty or nil if no errors), the other
callbacks must return the entire record, maybe with some attributes
changed, added, or deleted.

With MongoDB's default ACKNOWLEDGED value for WriteConcern [^1], the
:on-update-errors callback is called when there are network issues or
database server errors (ex. com.mongodb.DuplicateKeyException).

[^1]: <a href="http://docs.mongodb.org/manual/core/write-concern/#default-write-concern">http://docs.mongodb.org/manual/core/write-concern/#default-write-concern</a>

Returns:
  - [false validation-errors] if validations fail (where validation-errors
    is what the validator returned)
  - [false validation-errors] if no record is found with the specified id
  - [false {:base [:update-error]}] if update fails because of network
    issues or database server errors
  - [true updated-object] otherwise</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L233">view source</a></div></div><div class="public anchor" id="var-update-all"><h3>update-all</h3><div class="usage"><code>(update-all {:keys [database entity], :as model-component} updates conditions)</code></div><div class="doc"><pre class="plaintext">Applies the specified `updates` to all the records that match the
`conditions`. The `updates` have to specify the update operator to use
($set, $unset...).

Lifecycle callbacks and validations are not triggered.

The `conditions` MUST be supplied, to prevent the accidental update of all
the records in a collection. If that's really what's desired, an empty map
can be passed as the `conditions` parameter.

Example:
  (update-all product-component
              {:$set {:name "changed"}}
              {:name "test name"})</pre></div><div class="src-link"><a href="https://github.com/xavi/mongologic/blob/0.5.6/src/mongologic/core.clj#L173">view source</a></div></div></div></body></html>